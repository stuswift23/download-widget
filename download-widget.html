<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Download Recording Widget</title>
  <style>
    body {
      background-color: #f5f5f5;
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    h2 {
      color: #333;
    }
    .info {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>âœ… Widget Loaded Successfully</h2>
  <p>This is the custom Download Recording widget inside Supervisor Desktop.</p>
  <p class="info"><strong>Loaded at:</strong> <span id="timestamp"></span></p>

  <label for="taskId">Enter Task ID:</label><br />
  <input type="text" id="taskId" placeholder="e.g. abc1234" style="width: 100%; margin-top: 5px;" />
  <br /><br />
  <button onclick="fetchRecording()">Get Recording</button>

  <div id="result"></div>

  <script>
    document.getElementById("timestamp").textContent = new Date().toLocaleString();

    async function fetchRecording() {
      const taskId = document.getElementById("taskId").value.trim();
      const accessToken = getAttribute("access-token");
      const orgId = getAttribute("org-id");

      if (!taskId || !accessToken || !orgId) {
        document.getElementById("result").textContent = "Missing required values.";
        return;
      }

      const payload = {
        query: {
          orgId,
          urlExpiration: 30,
          taskIds: [taskId],
          includeSegments: false
        }
      };

      try {
        const res = await fetch("https://api.wxcc-us1.cisco.com/v1/captures/query", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "access-token": accessToken
          },
          body: JSON.stringify(payload)
        });

        const json = await res.json();
        const url = json?.data?.[0]?.url;

        if (url) {
          document.getElementById("result").innerHTML =
            `<a href="${url}" target="_blank">Download Recording</a>`;
        } else {
          document.getElementById("result").textContent = "No recording URL returned.";
        }
      } catch (err) {
        document.getElementById("result").textContent = "Error: " + err.message;
      }
    }

    function getAttribute(name) {
      return window?.frameElement?.getAttribute(name) || "";
    }
  </script>
</body>
</html>
